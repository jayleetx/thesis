```{r include = FALSE}
library(sf)
library(ggplot2)
library(broom)
library(here)
library(knitr)

sf_precincts <- st_read(dsn = here("data", "sf_precincts"), stringsAsFactors = FALSE)
colnames(sf_precincts) <- c('precinct', 'over_count', 'no_over_count', 'under_count',
                            'no_under_count', 'PREC_2017', 'population', 'female',
                            'pop_18_24', 'pop_25_44', 'pop_45_64', 'pop_65_plus',
                            'hispanic', 'white', 'black', 'native', 'asian', 'pac_islander',
                            'other_race', 'no_hs', 'college', 'poverty', 'no_english',
                            'weight', 'overvote_rate', 'undervote_rate', 'turnout',
                            'no_turnout', 'turnout_rate', 'geometry')
# this just undoes the var name shortening in the shapefile format

best_linear_turnout <- lm(turnout_rate ~ pop_18_24 + pop_45_64 + college, data = sf_precincts)
best_linear_over <- lm(overvote_rate ~ black + college, data = sf_precincts)
best_linear_under <- lm(undervote_rate ~ black + no_english, data = sf_precincts)
```

# Demographic analysis results {#demo-results}

For the following models, I use variables taken from the US Census 2018 Planning Database^[All descriptions taken from the Planning Database as well.], estimated for the election precincts through the areal interpolation method. All data is self-reported through the Census process^[In regards to the `female` variable: the Census specifically asks about binary sex; there are currently no questions about gender identity.]. A description of these variables is in the [Appendix](#appendix).

## Modeling turnout

```{r, fig.cap='Observed turnout rate by precinct'}
turnout_map <- ggplot(sf_precincts) + geom_sf(aes(fill = turnout_rate), lwd = 0) +
  theme_void()
turnout_hist <- ggplot(sf_precincts, aes(x = turnout_rate)) + geom_histogram() +
  theme_void()

turnout_map + turnout_hist + plot_layout(ncol = 2)
```

With an adjusted $R^2$ value of `r summary(best_linear_turnout)$adj.r.squared`, the best linear model we found for predicting turnout^[From the dataset, we removed one outlier with a turnout rate of 124%, Precinct 7024. We believe this is a particlarly egregious inaccuracy in the interpolation process of calculating population. The gaps in the map above and following maps are Golden Gate Park (to the northwest), Crocker-Amazon Playground and John McLaren Park (to the south), and our removed precinct 7024 (to the southeast).] included variables for both age and education. A district having more young people (ages 18-24) was negatively correlated with turnout, while having more middle-aged and college-educated people was positively correlated with turnout. This is consistent with general literature on voter turnout - young people vote less, and the better educated vote more.

```{r, fig.cap="Linear turnout model validation"}
kable(tidy(best_linear_turnout) %>% mutate(term = stringr::str_remove_all(term, '\\(|\\)')),
      caption = "Linear model for RCV voter turnout",
      caption.short = "Linear turnout model",
      longtable = TRUE,
      booktabs = TRUE)

a <- ggplot(best_linear_turnout, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Fitted values") +
  ylab("Residuals")

b <- ggplot(best_linear_turnout, aes(x = .resid)) +
  geom_histogram() +
  xlab("Residuals")
# linear model is not half bad at turnout
# slightly right skewed residuals, a few super high outliers
# investigate these

a + b + plot_layout(ncol = 2)
```

Logistic -

## Modeling overvoting

```{r, fig.cap='Observed overvote rate by precinct'}
overvote_map <- ggplot(sf_precincts) + geom_sf(aes(fill = overvote_rate), lwd = 0) +
  theme_void()
overvote_hist <- ggplot(sf_precincts, aes(x = overvote_rate)) + geom_histogram() +
  theme_void()

overvote_map + overvote_hist + plot_layout(ncol = 2)
```

With an adjusted $R^2$ value of `r summary(best_linear_over)$adj.r.squared`, the best linear model we found for predicting overvoting included variables for both race and education. A district being more African-American was positively correlated with overvoting, while having more college-educated people was negatively correlated with overvoting.

```{r, fig.cap="Linear overvote model validation"}
kable(tidy(best_linear_over) %>% mutate(term = stringr::str_remove_all(term, '\\(|\\)')),
      caption = "Linear model for overvoting in RCV",
      caption.short = "Linear overvote model",
      longtable = TRUE,
      booktabs = TRUE)

c <- ggplot(best_linear_over, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Fitted values") +
  ylab("Residuals")

d <- ggplot(best_linear_over, aes(x = .resid)) +
  geom_histogram() +
  xlab("Residuals")
# linear model is not half bad at turnout
# slightly right skewed residuals, a few super high outliers
# investigate these

c + d + plot_layout(ncol = 2)
```

Logistic

## Modeling undervoting

```{r, fig.cap='Observed undervote rate by precinct'}
undervote_map <- ggplot(sf_precincts) + geom_sf(aes(fill = undervote_rate), lwd = 0) +
  theme_void()
undervote_hist <- ggplot(sf_precincts, aes(x = undervote_rate)) + geom_histogram() +
  theme_void()

undervote_map + undervote_hist + plot_layout(ncol = 2)
```

With an adjusted $R^2$ value of `r summary(best_linear_under)$adj.r.squared`, the best linear model we found for predicting undervoting^[Here, the percentage of people who listed only 1 or 2 unique candidates out of the percentage of people who listed any number of candidates. This combines both "undervoting" as skipping ranking slots and "duplicated voting" as ranking the same candidate in multiple slots.] included variables for both race and education. Having more African-Americans and residents over 25 without a high school degree was negatively correlated with undervoting.

```{r, fig.cap="Linear undervote model validation"}
kable(tidy(best_linear_under) %>% mutate(term = stringr::str_remove_all(term, '\\(|\\)')),
      caption = "Linear model for undervoting in RCV",
      caption.short = "Linear undervote model",
      longtable = TRUE,
      booktabs = TRUE)

e <- ggplot(best_linear_under, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Fitted values") +
  ylab("Residuals")

f <- ggplot(best_linear_under, aes(x = .resid)) +
  geom_histogram() +
  xlab("Residuals")
# linear model is not half bad at turnout
# slightly right skewed residuals, a few super high outliers
# investigate these

e + f + plot_layout(ncol = 2)
```

Honestly I'm really unsure what's going on here. Heavily black precincts are more likely to undervote (lines up with general voting literature), but precincts with less education (less HS grads / less college grads) are less likely to undervote (doesn't line up), and precincts that speak English less well are also less likely to undervote. Just some unexpected and not always significant results.

And these are logistic for over and under - still need to do training/test or cross validation, plus better model selection.

```{r}
logit_over <- glm(cbind(over_count, no_over_count) ~ hispanic + black + no_english,
                  data = sf_precincts, family = binomial)

logit_under <- glm(cbind(under_count, no_under_count) ~
                  + pop_18_24
                  + pop_25_44
                  + pop_45_64
                  + hispanic
                  + white
                  + black
                  + asian
                  + no_hs
                  + college
                   ,
                   data = sf_precincts, family = binomial)

summary(logit_over)
summary(logit_under)
```

Try the glmulti package on the mLab computers, maybe their rJava will work better...?
https://rstudio-pubs-static.s3.amazonaws.com/2897_9220b21cfc0c43a396ff9abf122bb351.html
